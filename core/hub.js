/**
 * ÏÑºÏÑú Í≤åÏûÑ ÌóàÎ∏å v2.0 - Î©îÏù∏ JavaScript
 * ÌóàÎ∏å UI Í¥ÄÎ¶¨, Í≤åÏûÑ Î™©Î°ù, ÏÑºÏÑú ÏÉÅÌÉú Îì±ÏùÑ Ï≤òÎ¶¨
 */

class SensorGameHub {
    constructor() {
        this.socket = null;
        this.isConnected = false;
        this.games = new Map();
        this.currentFilter = 'all';
        this.stats = {
            totalGames: 0,
            activePlayers: 0,
            connectedSensors: 0
        };
        
        // Ïû¨Ïó∞Í≤∞ Í¥ÄÎ¶¨
        this.reconnectAttempts = 0;
        this.maxReconnectAttempts = 5;
        this.reconnectDelay = 1000;
        this.reconnectTimer = null;
        
        // ÏÑ±Îä• Î™®ÎãàÌÑ∞ÎßÅ
        this.performanceMetrics = {
            latency: 0,
            lastUpdate: Date.now(),
            connectionHealth: 'good'
        };
        
        this.init();
    }
    
    /**
     * ÌóàÎ∏å Ï¥àÍ∏∞Ìôî
     */
    init() {
        console.log('üéÆ ÏÑºÏÑú Í≤åÏûÑ ÌóàÎ∏å v2.0 Ï¥àÍ∏∞Ìôî');
        
        // WebSocket Ïó∞Í≤∞
        this.connectToServer();
        
        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
        this.setupEventListeners();
        
        // Í≤åÏûÑ Î™©Î°ù Î°úÎìú
        this.loadGames();
        
        // ÏÑúÎ≤Ñ ÏÉÅÌÉú Î°úÎìú
        this.loadServerStatus();
        
        // Ï£ºÍ∏∞Ï†Å ÏóÖÎç∞Ïù¥Ìä∏
        this.startPeriodicUpdates();
    }
    
    /**
     * WebSocket ÏÑúÎ≤Ñ Ïó∞Í≤∞
     */
    connectToServer() {
        try {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}`;
            
            this.socket = new WebSocket(wsUrl);
            
            this.socket.onopen = () => {
                this.isConnected = true;
                this.reconnectAttempts = 0; // Ïû¨Ïó∞Í≤∞ ÏÑ±Í≥µ Ïãú Ïπ¥Ïö¥ÌÑ∞ Î¶¨ÏÖã
                console.log('‚úÖ ÌóàÎ∏å ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÏÑ±Í≥µ');
                this.updateConnectionStatus(true);
                
                // Ïó∞Í≤∞ Ïò§Î•ò Î©îÏãúÏßÄ Ïà®Í∏∞Í∏∞
                const errorElement = document.getElementById('connectionError');
                if (errorElement) {
                    errorElement.style.display = 'none';
                }
                
                // ÌóàÎ∏å ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏Î°ú Îì±Î°ù
                this.socket.send(JSON.stringify({
                    type: 'register_hub_client',
                    timestamp: Date.now()
                }));
            };
            
            this.socket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    this.handleServerMessage(data);
                } catch (error) {
                    console.error('Î©îÏãúÏßÄ Ï≤òÎ¶¨ Ïò§Î•ò:', error);
                }
            };
            
            this.socket.onclose = (event) => {
                this.isConnected = false;
                console.log('üîå ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÎÅäÍπÄ:', event.code, event.reason);
                this.updateConnectionStatus(false);
                
                // ÏßÄÏàò Î∞±Ïò§ÌîÑÎ•º ÏÇ¨Ïö©Ìïú Ïû¨Ïó∞Í≤∞
                if (event.code !== 1000) { // Ï†ïÏÉÅ Ï¢ÖÎ£åÍ∞Ä ÏïÑÎãå Í≤ΩÏö∞Îßå Ïû¨Ïó∞Í≤∞
                    this.handleReconnect();
                }
            };
            
            this.socket.onerror = (error) => {
                console.error('WebSocket Ïò§Î•ò:', error);
            };
            
        } catch (error) {
            console.error('ÏÑúÎ≤Ñ Ïó∞Í≤∞ Ïã§Ìå®:', error);
            this.updateConnectionStatus(false);
        }
    }
    
    /**
     * ÏÑúÎ≤Ñ Î©îÏãúÏßÄ Ï≤òÎ¶¨
     */
    handleServerMessage(data) {
        switch (data.type) {
            case 'connection_established':
                console.log('ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÌôïÏù∏:', data);
                break;
                
            case 'sensor_device_connected':
                this.stats.connectedSensors++;
                this.updateStats();
                break;
                
            case 'sensor_device_disconnected':
                this.stats.connectedSensors = Math.max(0, this.stats.connectedSensors - 1);
                this.updateStats();
                break;
                
            case 'game_client_connected':
                this.stats.activePlayers++;
                this.updateStats();
                break;
                
            case 'game_client_disconnected':
                this.stats.activePlayers = Math.max(0, this.stats.activePlayers - 1);
                this.updateStats();
                break;
                
            case 'pong':
                this.updateLatency(data);
                this.updateConnectionHealth();
                break;
                
            case 'server_status':
                if (data.stats) {
                    this.stats.activePlayers = data.stats.activeGameClients || 0;
                    this.stats.connectedSensors = data.stats.activeSensorDevices || 0;
                    this.updateStats();
                }
                break;
        }
    }
    
    /**
     * Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
     */
    setupEventListeners() {
        // ÌïÑÌÑ∞ Î≤ÑÌäº
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                this.setFilter(e.target.dataset.filter);
            });
        });
        
        // Î™®Îã¨ Í¥ÄÎ†®
        const modal = document.getElementById('gameModal');
        const closeModal = document.getElementById('closeModal');
        
        if (closeModal) {
            closeModal.addEventListener('click', () => {
                modal.style.display = 'none';
            });
        }
        
        if (modal) {
            window.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
        
        // ÌÇ§Î≥¥Îìú Îã®Ï∂ïÌÇ§
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const modal = document.getElementById('gameModal');
                if (modal.style.display === 'block') {
                    modal.style.display = 'none';
                }
            }
        });
    }
    
    /**
     * Í≤åÏûÑ Î™©Î°ù Î°úÎìú
     */
    async loadGames() {
        try {
            this.showLoading(true);
            
            const response = await fetch('/api/games');
            const data = await response.json();
            
            if (data.success) {
                this.games.clear();
                data.games.forEach(game => {
                    this.games.set(game.id, game);
                });
                
                this.stats.totalGames = data.total;
                this.renderGames();
                this.updateStats();
            } else {
                console.error('Í≤åÏûÑ Î™©Î°ù Î°úÎìú Ïã§Ìå®:', data.error);
                this.showNoGames();
            }
        } catch (error) {
            console.error('Í≤åÏûÑ Î™©Î°ù Î°úÎìú Ïò§Î•ò:', error);
            this.showNoGames();
        } finally {
            this.showLoading(false);
        }
    }
    
    /**
     * ÏÑúÎ≤Ñ ÏÉÅÌÉú Î°úÎìú
     */
    async loadServerStatus() {
        try {
            const response = await fetch('/api/status');
            const data = await response.json();
            
            if (data.success) {
                this.stats.activePlayers = data.status.activeGameClients;
                this.stats.connectedSensors = data.status.activeSensorDevices;
                this.updateStats();
            }
        } catch (error) {
            console.error('ÏÑúÎ≤Ñ ÏÉÅÌÉú Î°úÎìú Ïò§Î•ò:', error);
        }
    }
    
    /**
     * Í≤åÏûÑ Î™©Î°ù Î†åÎçîÎßÅ
     */
    renderGames() {
        const gamesGrid = document.getElementById('gamesGrid');
        if (!gamesGrid) return;
        
        // ÌïÑÌÑ∞ÎßÅÎêú Í≤åÏûÑ Î™©Î°ù
        const filteredGames = Array.from(this.games.values())
            .filter(game => this.currentFilter === 'all' || game.category === this.currentFilter)
            .sort((a, b) => b.playCount - a.playCount);
        
        if (filteredGames.length === 0) {
            gamesGrid.innerHTML = '';
            this.showNoGames();
            return;
        }
        
        gamesGrid.innerHTML = filteredGames.map(game => this.createGameCard(game)).join('');
        
        // Í≤åÏûÑ Ïπ¥Îìú ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
        gamesGrid.querySelectorAll('.game-card').forEach(card => {
            card.addEventListener('click', () => {
                const gameId = card.dataset.gameId;
                this.openGame(gameId);
            });
        });
        
        this.showNoGames(false);
    }
    
    /**
     * Í≤åÏûÑ Ïπ¥Îìú HTML ÏÉùÏÑ±
     */
    createGameCard(game) {
        const difficultyColors = {
            easy: '#00ff88',
            medium: '#ffaa00',
            hard: '#ff4757'
        };
        
        return `
            <div class="game-card" data-game-id="${game.id}">
                <div class="game-header">
                    <div class="game-icon">${game.icon}</div>
                    <div class="game-info">
                        <div class="game-title">${game.name}</div>
                        <div class="game-author">by ${game.author}</div>
                    </div>
                </div>
                <div class="game-description">${game.description}</div>
                <div class="game-meta">
                    <span class="game-category">${this.getCategoryName(game.category)}</span>
                    <span class="game-difficulty" style="color: ${difficultyColors[game.difficulty] || '#808080'}">
                        ${this.getDifficultyName(game.difficulty)}
                    </span>
                </div>
                <div class="game-stats">
                    <span>ÌîåÎ†àÏù¥ ${game.playCount}Ìöå</span>
                    <span>v${game.version}</span>
                </div>
            </div>
        `;
    }
    
    /**
     * Í≤åÏûÑ Ïã§Ìñâ
     */
    openGame(gameId) {
        const game = this.games.get(gameId);
        if (!game) {
            console.error('Í≤åÏûÑÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§:', gameId);
            return;
        }
        
        // ÌîåÎ†àÏù¥ Ïπ¥Ïö¥Ìä∏ Ï¶ùÍ∞Ä
        this.incrementPlayCount(gameId);
        
        // ÏÉà Ï∞ΩÏóêÏÑú Í≤åÏûÑ Ïó¥Í∏∞
        window.open(game.path, '_blank');
    }
    
    /**
     * ÌîåÎ†àÏù¥ Ïπ¥Ïö¥Ìä∏ Ï¶ùÍ∞Ä
     */
    async incrementPlayCount(gameId) {
        try {
            const response = await fetch(`/api/games/${gameId}/play`, {
                method: 'POST'
            });
            
            if (response.ok) {
                const game = this.games.get(gameId);
                if (game) {
                    game.playCount++;
                    this.renderGames(); // ÏóÖÎç∞Ïù¥Ìä∏Îêú Ïπ¥Ïö¥Ìä∏Î°ú Îã§Ïãú Î†åÎçîÎßÅ
                }
            }
        } catch (error) {
            console.error('ÌîåÎ†àÏù¥ Ïπ¥Ïö¥Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò:', error);
        }
    }
    
    /**
     * ÌïÑÌÑ∞ ÏÑ§Ï†ï
     */
    setFilter(filter) {
        this.currentFilter = filter;
        
        // ÌïÑÌÑ∞ Î≤ÑÌäº ÌôúÏÑ±Ìôî ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
        
        // Í≤åÏûÑ Î™©Î°ù Îã§Ïãú Î†åÎçîÎßÅ
        this.renderGames();
    }
    
    /**
     * Ïó∞Í≤∞ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
     */
    updateConnectionStatus(connected) {
        const statusIcon = document.getElementById('connectionStatus');
        const statusText = document.getElementById('connectionText');
        
        if (statusIcon && statusText) {
            if (connected) {
                statusIcon.textContent = 'üü¢';
                statusText.textContent = 'ÏÑúÎ≤Ñ Ïó∞Í≤∞Îê®';
            } else {
                statusIcon.textContent = 'üî¥';
                statusText.textContent = 'ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÎÅäÍπÄ';
            }
        }
    }
    
    /**
     * ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
     */
    updateStats() {
        const elements = {
            totalGames: document.getElementById('totalGames'),
            activePlayers: document.getElementById('activePlayers'),
            connectedSensors: document.getElementById('connectedSensors'),
            deviceCount: document.getElementById('deviceCount')
        };
        
        if (elements.totalGames) {
            this.animateNumber(elements.totalGames, this.stats.totalGames);
        }
        
        if (elements.activePlayers) {
            this.animateNumber(elements.activePlayers, this.stats.activePlayers);
        }
        
        if (elements.connectedSensors) {
            this.animateNumber(elements.connectedSensors, this.stats.connectedSensors);
        }
        
        if (elements.deviceCount) {
            elements.deviceCount.textContent = this.stats.connectedSensors;
        }
    }
    
    /**
     * Ïà´Ïûê Ïï†ÎãàÎ©îÏù¥ÏÖò
     */
    animateNumber(element, targetValue) {
        const currentValue = parseInt(element.textContent) || 0;
        const increment = Math.ceil((targetValue - currentValue) / 10);
        
        if (currentValue < targetValue) {
            element.textContent = Math.min(currentValue + increment, targetValue);
            setTimeout(() => this.animateNumber(element, targetValue), 50);
        } else if (currentValue > targetValue) {
            element.textContent = Math.max(currentValue - increment, targetValue);
            setTimeout(() => this.animateNumber(element, targetValue), 50);
        }
    }
    
    /**
     * Ïû¨Ïó∞Í≤∞ Ï≤òÎ¶¨ (ÏßÄÏàò Î∞±Ïò§ÌîÑ)
     */
    handleReconnect() {
        if (this.reconnectAttempts >= this.maxReconnectAttempts) {
            console.error('‚ùå ÏµúÎåÄ Ïû¨Ïó∞Í≤∞ ÏãúÎèÑ ÌöüÏàò Ï¥àÍ≥º');
            this.showConnectionError('ÏÑúÎ≤Ñ Ïó∞Í≤∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®ÌïòÏÑ∏Ïöî.');
            return;
        }
        
        this.reconnectAttempts++;
        const delay = this.reconnectDelay * Math.pow(2, this.reconnectAttempts - 1);
        
        console.log(`üîÑ Ïû¨Ïó∞Í≤∞ ÏãúÎèÑ ${this.reconnectAttempts}/${this.maxReconnectAttempts} (${delay}ms ÌõÑ)`);
        
        this.reconnectTimer = setTimeout(() => {
            this.connectToServer();
        }, delay);
    }
    
    /**
     * Ïó∞Í≤∞ Ïò§Î•ò ÌëúÏãú
     */
    showConnectionError(message) {
        const errorElement = document.getElementById('connectionError');
        if (errorElement) {
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }
    }
    
    /**
     * Ïó∞Í≤∞ ÏÉÅÌÉú Í±¥Í∞ïÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
     */
    updateConnectionHealth() {
        const now = Date.now();
        const timeSinceLastUpdate = now - this.performanceMetrics.lastUpdate;
        
        if (timeSinceLastUpdate > 30000) { // 30Ï¥à Ïù¥ÏÉÅ
            this.performanceMetrics.connectionHealth = 'poor';
        } else if (timeSinceLastUpdate > 10000) { // 10Ï¥à Ïù¥ÏÉÅ
            this.performanceMetrics.connectionHealth = 'fair';
        } else {
            this.performanceMetrics.connectionHealth = 'good';
        }
        
        this.performanceMetrics.lastUpdate = now;
        this.updatePerformanceDisplay();
    }
    
    /**
     * ÏÑ±Îä• ÏßÄÌëú ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
     */
    updatePerformanceDisplay() {
        const healthElement = document.getElementById('connectionHealth');
        if (healthElement) {
            const health = this.performanceMetrics.connectionHealth;
            const healthColors = {
                good: '#00ff88',
                fair: '#ffaa00', 
                poor: '#ff4757'
            };
            const healthLabels = {
                good: 'ÏñëÌò∏',
                fair: 'Î≥¥ÌÜµ',
                poor: 'Î∂àÎüâ'
            };
            
            healthElement.textContent = healthLabels[health];
            healthElement.style.color = healthColors[health];
        }
    }
    
    /**
     * ÏßÄÏó∞ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏
     */
    updateLatency(data) {
        const latency = Date.now() - data.timestamp;
        this.performanceMetrics.latency = latency;
        
        const latencyElement = document.getElementById('latency');
        if (latencyElement) {
            latencyElement.textContent = `${latency}ms`;
            
            // ÏßÄÏó∞ÏãúÍ∞ÑÏóê Îî∞Î•∏ ÏÉâÏÉÅ Î≥ÄÍ≤Ω
            if (latency < 100) {
                latencyElement.style.color = '#00ff88';
            } else if (latency < 300) {
                latencyElement.style.color = '#ffaa00';
            } else {
                latencyElement.style.color = '#ff4757';
            }
        }
    }
    
    /**
     * Î°úÎî© ÏÉÅÌÉú ÌëúÏãú
     */
    showLoading(show) {
        const loading = document.getElementById('gamesLoading');
        if (loading) {
            loading.style.display = show ? 'block' : 'none';
        }
    }
    
    /**
     * Í≤åÏûÑ ÏóÜÏùå ÏÉÅÌÉú ÌëúÏãú
     */
    showNoGames(show = true) {
        const noGames = document.getElementById('noGames');
        if (noGames) {
            noGames.style.display = show ? 'block' : 'none';
        }
    }
    
    /**
     * Ï£ºÍ∏∞Ï†Å ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÏûë
     */
    startPeriodicUpdates() {
        // 30Ï¥àÎßàÎã§ ÏÑúÎ≤Ñ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        setInterval(() => {
            this.loadServerStatus();
        }, 30000);
        
        // 5Ï¥àÎßàÎã§ ping Ï†ÑÏÜ° (ÏßÄÏó∞ÏãúÍ∞Ñ Ï∏°Ï†ï)
        setInterval(() => {
            if (this.isConnected && this.socket && this.socket.readyState === WebSocket.OPEN) {
                this.socket.send(JSON.stringify({
                    type: 'ping',
                    timestamp: Date.now()
                }));
            }
        }, 5000);
        
        // Ïó∞Í≤∞ ÏÉÅÌÉú Í±¥Í∞ïÎèÑ Î™®ÎãàÌÑ∞ÎßÅ
        setInterval(() => {
            this.updateConnectionHealth();
        }, 10000);
    }
    
    /**
     * Ïπ¥ÌÖåÍ≥†Î¶¨ Ïù¥Î¶Ñ Î≥ÄÌôò
     */
    getCategoryName(category) {
        const names = {
            puzzle: 'ÌçºÏ¶ê',
            action: 'Ïï°ÏÖò',
            racing: 'Î†àÏù¥Ïã±',
            sport: 'Ïä§Ìè¨Ï∏†',
            casual: 'Ï∫êÏ£ºÏñº',
            arcade: 'ÏïÑÏºÄÏù¥Îìú'
        };
        return names[category] || category;
    }
    
    /**
     * ÎÇúÏù¥ÎèÑ Ïù¥Î¶Ñ Î≥ÄÌôò
     */
    getDifficultyName(difficulty) {
        const names = {
            easy: 'Ïâ¨ÏõÄ',
            medium: 'Î≥¥ÌÜµ',
            hard: 'Ïñ¥Î†§ÏõÄ'
        };
        return names[difficulty] || difficulty;
    }
}

// ÌóàÎ∏å Ï¥àÍ∏∞Ìôî
document.addEventListener('DOMContentLoaded', () => {
    window.sensorGameHub = new SensorGameHub();
});

// Ï†ÑÏó≠ Ìï®ÏàòÎì§ (ÌïÑÏöîÏãú ÏÇ¨Ïö©)
window.openGame = (gameId) => {
    if (window.sensorGameHub) {
        window.sensorGameHub.openGame(gameId);
    }
};

window.setGameFilter = (filter) => {
    if (window.sensorGameHub) {
        window.sensorGameHub.setFilter(filter);
    }
};